name: Gemini PR Auto-Description

on:
  pull_request:
    types: [ opened ]

jobs:
  gemini-summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Summary and Update PR
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          BASE_REF: origin/${{ github.base_ref }}
        with:
          script: |
            const { execSync } = require('child_process');

            // 1. ë°ì´í„° ì¶”ì¶œ
            let diff = "";
            let commits = "";
            let diffStat = "";
            
            // í™˜ê²½ë³€ìˆ˜ ì²˜ë¦¬ (ì—†ì„ ê²½ìš° ëŒ€ë¹„)
            const baseRef = process.env.BASE_REF || 'origin/main';

            try {
              // diff ì–‘ì´ ë§ì„ ê²½ìš° ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ ë¼ì¸ ìˆ˜ ì œí•œ (head -n 1000)
              diff = execSync(`git diff ${baseRef}...HEAD | head -n 1000`).toString();
              diffStat = execSync(`git diff --stat ${baseRef}...HEAD`).toString();
              commits = execSync(`git log ${baseRef}...HEAD --pretty=format:"- %s"`).toString();
            } catch (e) {
              console.error("Git ë°ì´í„° ì¶”ì¶œ ì‹¤íŒ¨:", e);
              diff = "ë°ì´í„° ì¶”ì¶œ ì‹¤íŒ¨ (ë³€ê²½ ì‚¬í•­ì´ ë„ˆë¬´ í¬ê±°ë‚˜ ë¸Œëœì¹˜ ì°¸ì¡° ì˜¤ë¥˜)";
            }

            // 2. PR í…œí”Œë¦¿ (ì¼ë°˜ ë¬¸ìì—´ë¡œ ì •ì˜)
            const PR_TEMPLATE = [
              "## #ï¸âƒ£ ë³€ê²½ ì‚¬í•­",
              "",
              "## #ï¸âƒ£ ì‘ì—… ìƒì„¸ ë‚´ìš©",
              "- ìƒì„¸ ë‚´ìš© 1",
              "- ìƒì„¸ ë‚´ìš© 2",
              "",
              "## #ï¸âƒ£ ê´€ë ¨ ì´ìŠˆ",
              "- Closes #",
              "- Related to #",
              "",
              "## ğŸ“¸ ìŠ¤í¬ë¦°ìƒ· (ì„ íƒ)",
              "### ë³€ê²½ ì „",
              "### ë³€ê²½ í›„",
              "",
              "## ğŸ“ ì°¸ê³ í• ë§Œí•œ ìë£Œ (ì„ íƒ)"
            ].join("\n");

            // 3. Gemini API í˜¸ì¶œ
            // ğŸš¨ ì£¼ì˜: 'gemini-3-flash'ëŠ” ì•„ì§ ê³µê°œë˜ì§€ ì•Šì•˜ê±°ë‚˜ ë¹„ê³µê°œ ëª¨ë¸ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ì—ëŸ¬ê°€ ê³„ì†ëœë‹¤ë©´ 'gemini-1.5-flash'ë¡œ ë³€ê²½í•˜ì„¸ìš”.
            const model = "gemini-1.5-flash"; 
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;

            try {
              // í”„ë¡¬í”„íŠ¸ êµ¬ì„± (ë°±í‹± ì¤‘ì²© ë°©ì§€ë¥¼ ìœ„í•´ ë¬¸ìì—´ ê²°í•© ì‚¬ìš©)
              const systemPrompt = "ë„ˆëŠ” ìœ ëŠ¥í•œ ì†Œí”„íŠ¸ì›¨ì–´ ì—”ì§€ë‹ˆì–´ë‹¤. ì•„ë˜ ì œê³µëœ ì»¤ë°‹ ë‚´ì—­ê³¼ ì½”ë“œ ë³€ê²½ ì‚¬í•­ì„ ë¶„ì„í•˜ì—¬ ì£¼ì–´ì§„ 'PR í…œí”Œë¦¿ í˜•ì‹'ì— ë§ì¶° PR ë³¸ë¬¸ì„ ì‘ì„±í•´ë¼.\n" +
                                   "ê´€ë ¨ ì´ìŠˆ, ìŠ¤í¬ë¦°ìƒ·, ì°¸ê³ í• ë§Œí•œ ìë£ŒëŠ” í…œí”Œë¦¿ í˜•ì‹ì„ ê·¸ëŒ€ë¡œ ìœ ì§€í•  ê²ƒ.\n" +
                                   "í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ê³ , ê¸°ìˆ ì ì¸ ìš©ì–´ëŠ” ì •í™•í•˜ê²Œ ì‚¬ìš©í•´ë¼. ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì„ ìœ ì§€í•´ë¼. ë¶€ê°€ì ì¸ ì¸ì‚¬ë§ ì—†ì´ PR ë‚´ìš©ë§Œ ì¶œë ¥í•´ë¼.";
              
              const userContent = "[PR í…œí”Œë¦¿ í˜•ì‹]\n" + PR_TEMPLATE + "\n\n" +
                                  "[ì»¤ë°‹ ë©”ì‹œì§€ ëª©ë¡]\n" + commits + "\n\n" +
                                  "[ë³€ê²½ íŒŒì¼ ìš”ì•½]\n" + diffStat + "\n\n" +
                                  "[ìƒì„¸ ì½”ë“œ ë³€ê²½ ë‚´ìš©]\n" + diff;

              const response = await fetch(url, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-goog-api-key': process.env.GEMINI_API_KEY
                },
                body: JSON.stringify({
                  contents: [{
                    parts: [{
                      text: systemPrompt + "\n\n" + userContent
                    }]
                  }]
                })
              });

              const data = await response.json();
              if (data.error) throw new Error(data.error.message);
              
              const summary = data.candidates?.[0]?.content?.parts?.[0]?.text || "ìš”ì•½ ìƒì„± ì‹¤íŒ¨";

              // 4. Footer ì‘ì„± (ë°°ì—´ joinì„ ì‚¬ìš©í•˜ì—¬ ë¬¸ë²• ì˜¤ë¥˜ ì›ì²œ ì°¨ë‹¨)
              const footer = [
                "",
                "",
                "---",
                "> **AI ìë™ ìƒì„± ê²°ê³¼** (ë‚´ìš© í™•ì¸ í›„ ì‚­ì œ ë° ìˆ˜ì •í•˜ì—¬ ì‚¬ìš©í•˜ì„¸ìš”)",
                "",
                "```",
                "âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸",
                "- ì½”ë“œê°€ í”„ë¡œì íŠ¸ì˜ ì½”ë”© ì»¨ë²¤ì…˜ì„ ë”°ë¦…ë‹ˆë‹¤",
                "- ë¬¸ì„œë¥¼ ì—…ë°ì´íŠ¸í–ˆìŠµë‹ˆë‹¤ (í•„ìš”í•œ ê²½ìš°)",
                "- ê´€ë ¨ ì´ìŠˆë¥¼ ì—°ê²°í–ˆìŠµë‹ˆë‹¤",
                "- ë¶€ê°€ì ì¸ ë‚´ìš© ì‘ì„±í–ˆìŠµë‹ˆë‹¤",
                "```"
              ].join("\n");

              // 5. PR ì—…ë°ì´íŠ¸
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                body: summary + footer
              });

            } catch (error) {
              console.error("Gemini API í˜¸ì¶œ ì¤‘ ì—ëŸ¬:", error);
              // í•„ìš” ì‹œ ì‹¤íŒ¨ ì²˜ë¦¬: core.setFailed(error.message);
            }
            
