: 사용자에게 보여지는 부가 설명 데이터(업데이트 시간)의 신뢰성

: stale 상태 캐시 데이터로 인한 화면 깜빡임 및 오해

# 지표카드가 업데이트된 시간

<img width="571" height="222" alt="스크린샷 2026-02-26 오후 11 43 47" src="https://github.com/user-attachments/assets/be2f2ea9-e493-4b83-8ac3-8efc4cfc4035" />


원래 섹션별로 새로고침된 시간 정보, 새로고침 버튼 제공

> 문제 상황 1)  카드 중 통신에 실패한 case가 있다면?
> 

<img width="1095" height="424" alt="스크린샷 2026-02-26 오후 6 33 08" src="https://github.com/user-attachments/assets/9756e4f6-00a3-4b90-9c2e-7f3aca83fbeb" />

- 2번째 카드 오류 발생
- 5분뒤인 37분에 다시 불러오기 → 성공
- 이때 섹션 상단에 나오는 새로고침된 시간은 몇분으로 나와야 할까??
    
    > 방법1 : 모든 카드들이 업데이트가 이루어진 걸 보장할 수 있는 최소 시간 출력
    > 
    
    섹션 내 카드들의 데이터 들의 마지막으로  갱신된 시간 수집(탄스택쿼리 캐시의 dataUpdatedAt 데이터 수집)
    
    → 모든 카드들은 그 시간들 중 가장 옛날 시간 이후에 최신 데이터로 업데이트 된 것이 보장됨
    
    ⇒ 해당 시간을 업데이트 시간으로 출력 + 문구를 ‘전체 새로고침 시간’ 으로 변경
    
    > 발생 문제점
    > 
    
    : 2번 카드는 37분에 새로고침 되었는데 35분에 업데이트된 다른 카드들로 인해서 섹션의 새로고침 시간 계속 35분으로 표기 → 사용자 입장에서 혼돈(새로고침 된거야 안된거야)
    
    > 방법2 : 하나라도 재시도 하면 섹션 전체  새로고침
    > 
    
    : 2번 카드 다시불러오기 → 1~5번 카드 모두 다 다시 새로고침
    
    → 섹션 내 모든 카드들이 다 같은 시간에 새로고침된 것 보장
    
    ⇒ 2번 카드 새로고침 요청 시간으로 출력
    
    > 발생 문제점
    > 
    
    : 사용자는 2번 카드만 새로고침 눌렀는데 옆 카드들도 내용 변경 또는 로딩 UI
    
    → 사용자 입장에서 혼돈(얘네들은 왜 새로고침 돼)
    

> 문제2) 카드별로 기간 설정 기능을 따로 제공하는 섹션 존재
> 

<img width="1103" height="550" alt="스크린샷 2026-02-26 오후 11 44 07" src="https://github.com/user-attachments/assets/f8284877-8a45-402e-82a8-18c9f88c078a" />

: 매출 추이 섹션의 경우 일별 매출 추이와 주별 매출 추이가 각각 독립적으로 기간 설정 기능을 제공

→ 기간 설정을 바꾸면 해당 카드만 업데이트 됨. → 섹션의 새로고침 시간을 언제로??

> 📝 해결방안
> 

<img width="563" height="267" alt="스크린샷 2026-02-26 오후 11 40 59" src="https://github.com/user-attachments/assets/68ada479-ffaf-4e3d-af90-722528859377" />

: 각 카드마다 개별적인 업데이트 시간과 새로고침 버튼 제공

→ 해당 카드가 사용하는 쿼리의 데이터가 마지막으로  갱신된 시간인 dataUpdatedAt 값을 확인해 새로고침 된 시간으로 안내

```
const queryState = queryClient.getQueryState(queryKey);
const updatedAt = queryState?.dataUpdatedAt;
```

각 카드의 쿼리 키: ["sales","overview","orderCount",{"analysisCardCode":"SLS_02_01","customPeriod":false}]

- 기간 변경 시 모든 카드 refetch
- 특정 카드 오류 발생 시 해당 카드만 업데이트해도 문제 없음

---

# 탄스택 쿼리 stale 데이터로 인한 화면 데이터 깜빡임에 대한 고민

TanStack Query는 데이터가 stale여도 **일단 기존 캐시 데이터를 화면에 그대로 보여주고 백그라운드에서 refetch를 실행한다. 데이터 성공적으로 받아오면 화면을 최신 데이터로 업데이트 함.**

> 문제점 : 요청 응답에 시간이 오래 걸리면 사용자 화면에는 예전 데이터가 계속 노출되고, 이후 과거데이터 → 현재 데이터로 교체되는 과정에서 데이터가 깜빡이게 느껴진다
> 

예시 상황

https://github.com/user-attachments/assets/80198724-c48b-4085-a382-94545e7ca9e5



: 네트워크 fast 4G상황

사용자가 `오늘` 주문건수 데이터(8건) 확인(캐싱됨. 그래도 바로 stale상태) 

→ 사용자가 `이번주` 버튼을 눌러 `이번주` 데이터 확인 

**→ [새로운 주문 1건 발생]** 

**→** 다시 `오늘` 데이터 버튼 눌러서 `오늘` 데이터 확인 요청 

→ (……네트워크……) 

→ 화면에는 stale상태의 새로운 주문 발생 이전의 `오늘` 주문건수 데이터 나온다(8건)

→ (요청된 데이터 도착)

→ 새로 받아온 데이터로 화면 업데이트(9건)

⇒ 숫자 변동 2번 발생. 데이터 깜빡임 발생

> 해결법 1: gcTime 0으로 설정
> 

: gcTime을 0으로 설정하면 메모리에서 아예 사라짐으로 stale된 데이터가 화면에 보여져서 발생하는 문제 해결

> 문제점 : 매번 빈 로딩 화면 노출
> 

: 특히 애니메이션이 적용되어 있는 그래프의 경우 데이터 변동에 따른 자연스로운 차트 이동 애니메이션을 하나도 보여주지 못함

> 해결법 2 : 이전 화면(`이번주` ) 정보 그대로 보여주고 `오늘` 데이터가 도착했을 때 화면 변경)
> 

: 다시 `오늘` 버튼을 눌러도 컴포넌트에서 직전에 랜더링 했던 데이터(캐싱된 `오늘` 데이터가 아닌 방금까지 화면에 보여지던 `이번주` 데이터)를 로딩중에 보여지게 

→ `오늘` 데이터 수신 완료 되었을 때 `오늘`에 대한 정보가 담긴 카드로 다시 랜더링

→ 화면에 보여지는 데이터 변화 1번만 발생 → 데이터 흔들림 문제 해결

→ 변화된 데이터에 따른 그래프 애니메이션 작동 (이전 데이터 계속 화면에 남아 있었기 때문)

- placeholderData : 로딩중일 때 화면에 보여줄 데이터 설정 가능
- placeholderData: keepPreviousData ⇒ 방금까지 화면에 보여지던 데이터를 로딩중일 때 보여줘
    
    ⇒ 단 쿼리키에 해당하는 캐시가 ‘undefined’일때만 작동함. 우리의 경우 이전 캐시 내용 있어서(비록 상한 상태지만) placeholderData 옵션 동작 안함
    
    ⇒ useRef로 이전 화면에 랜더링 중이던 데이터(`이번주` 에 해당하는 데이터) 저장. isFetching 중일 땐 ref에서 값 껴내서 화면에 보여주기
    

> 문제점 : 네트워크가 많이 느린 환경에서는 버튼 오작동처럼 느껴짐
> 

: 네트워크가 많이 느린 환경에서는 `이번주` 데이터를 보고 있던 사용자가 `오늘` 버튼을 눌러도 `이번주` 데이터만 오랫동안 보여짐. 한참 뒤에  `오늘` 데이터 도착하면 그때 되어서야 업데이트

→ 사용자 입장에서는 버튼이 동작 안한다고 느껴질 수 있음

> 해결법3 :  isFetching 동안에는 뒷 배경 블러처리 하는 오버레이 씌우기
> 

: useSuspenseQuery 대신 useQuery를 사용해 isfetching 정보(현재 데이터 로딩중인지)를 확보. 

→ isFetching 동안에는 뒷 배경 블러처리 하는 오버레이 씌우기

https://github.com/user-attachments/assets/274a33df-bf01-40f4-b13f-fb54f8d823d3




장점 ) 뒷배경에 이전 정보 표시되어 단순히 빈 로딩 화면보다 UX 향상

장점 ) 네트워크가 느린 환경에서도 데이터 흔들림 현상 방지(이전 데이터가 블러 처리가 되어 사용자가 인식 x)

장점 ) 이전 데이터가 남아있기 때문에 새로운 데이터 들어왔을 때 그래프 애니메이션 작동 

> 적용 못한 이유
> 

; 네트워크가 빠른 환경에서는 refetch 요청과 거의 동시에 데이터가 도착. ⇒ stale데이터 화면에 보여져도 바로 사라지기 때문에 사용자가 인지하기 힘듦. 

⇒ 로딩 오버레이 화면이 오히려 UX를 더 해치는 상황 발생 (생겼다가 바로 사라짐)

⇒ 기획상 국내 사장님들 대상 서비스로 대부분 빠른 네트워크 환경

⇒ 느린 네트워크 한경에 대한 고민으로 구현한 기능의 필요성이 떨어짐

⇒ 비록 구현한 내용을 실제 적용은 하지 못했지만 이런 UX적인 부분을 고민하면서 탄스택 쿼리의 속성에 대해 자세히 이해할