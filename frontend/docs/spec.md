# AI Mate 챗봇 기능 명세 (HTTP REST, 비스트리밍)

기존에 있는 ai-chat/ 컴포넌트에 API를 연동한다.
지금 있는 useChatStream의 스트리밍 코드를 제거하고, 요청-응답 단건 처리 기반의 챗봇 UX를 구현한다.

## 기능 개요

- 대상: 대시보드 내 좌측 하단 `AI mate` 채팅 패널
- 목적: 현재 보고 있는 대시보드 맥락에서 운영 인사이트 질의/응답 제공
- 참고 UX: Claude/Gemini 스타일의 간결한 대화 흐름
- 핵심 제약: 채팅 API는 **스트리밍이 아닌 HTTP REST**로 동작

## UX 요구사항

### 1) 초기 상태 (이미지 1)

- 채팅 패널 헤더에 `AI mate` 타이틀과 닫기 버튼 표시
- 첫 진입 시 안내 문구와 신뢰도 안내(데이터 부족 시 정확도 저하) 노출
- 빠른 질문 칩 3개 노출
  - `지금 상태 한 줄로 요약해줘`
  - `이 화면에서 주의할 포인트가 있을까?`
  - `지금부터 확인하면 좋을지 우선순위로 알려줘`
- 입력창 placeholder: `무엇이든 물어보세요.`
- 입력값이 비어 있으면 전송 버튼 비활성화

### 2) 질문 전송 상태 (이미지 2)

- 사용자가 질문 입력 후 전송 시 사용자 말풍선 즉시 추가
- 질문 등록 직후, 해당 질문 말풍선이 채팅창 최상단에 오도록 자동 스크롤
- 서버 응답 대기 중에는 `답변 생각 중...` 로딩 상태 표시
- 로딩 중 입력창은 유지하되, 전송 버튼은 `중지` 아이콘으로 전환
- `중지` 클릭 시 진행 중 요청 취소(AbortController), 로딩 상태 종료

### 3) 답변 완료 상태 (이미지 3)

- 응답 수신 후 AI 메시지를 프론트에서 점진 렌더링해 스트리밍처럼 표시
- 답변 렌더링은 Plain text 기반으로 처리
- 응답 도착 시, 직전 질문이 채팅창 최상단에 오도록 1회 자동 스크롤
- 응답 하단 입력창은 즉시 재사용 가능 상태로 복귀
- 스트리밍 중에는 연속 스크롤하지 않음

## 상호작용 규칙

- Enter: 전송
- Shift + Enter: 줄바꿈
- 중복 전송 방지: 요청 진행 중에는 새 요청 전송 불가
- 채팅 히스토리: 같은 패널 세션 내에서 `user/assistant` 순서 유지
- 패널 닫기 후 재오픈 시 정책
  - 재오픈 시 초기화

## API 호출 정책 (비스트리밍 고정)

- 통신 방식: `POST /api/chats` 단건 호출
- 요청 1건당 응답 1건(전체 답변 완성 후 수신), 이후 프론트에서 점진 렌더링
- SSE/WebSocket/chunked streaming 렌더링 미사용
- 클라이언트 타임아웃 권장: 30초
- 취소 처리: fetch abort 시 사용자에게 `요청이 취소되었습니다.` 안내

## 엔드포인트

/api/chats

## ChatRequest (Request Body)

AI Mate 대화 요청 객체입니다.

### 필드 정의

| 필드명              | 타입            | 필수 여부       | 설명                                                 | 예시                                                      |
| ------------------- | --------------- | --------------- | ---------------------------------------------------- | --------------------------------------------------------- |
| `history`           | `array<object>` | 선택            | 이전 대화 이력                                       | `[{"role":"user","content":"오늘 매출 현황 좀 알려줘."}]` |
| `history[].role`    | `string`        | 선택            | 메시지 발화자 역할 (`user`: 사용자, `assistant`: AI) | `"user"`                                                  |
| `history[].content` | `string`        | 선택            | 메시지 내용                                          | `"오늘 매출 현황 좀 알려줘."`                             |
| `question`          | `string`        | 필수 (최소 1자) | 현재 사장님의 질문                                   | `"매출 상승 전략 좀 알려줘."`                             |

### Example Request Body

```json
{
  "history": [
    {
      "role": "user",
      "content": "오늘 매출 현황 좀 알려줘."
    },
    {
      "role": "assistant",
      "content": "오늘 매출은 전일 대비 8% 상승했습니다."
    }
  ],
  "question": "매출 상승 전략 좀 알려줘."
}
```

## Response

### 상태 코드 요약

| HTTP Status | 설명                                          |
| ----------- | --------------------------------------------- |
| `200`       | AI 응답 생성 성공                             |
| `401`       | 토큰 오류                                     |
| `500`       | 서버 내부 오류 (LLM 연동 및 데이터 파싱 실패) |

### 200 OK - AI 응답 생성 성공

```json
{
  "success": true,
  "message": "AI 응답 생성에 성공했습니다.",
  "data": {
    "answer": "오늘은 평소보다 객단가가 높네요! 인기 메뉴인 세트 A의 판매 비중이 늘어난 덕분이에요. 내일은 이 세트 메뉴를 상단에 배치해보는 건 어떨까요?"
  }
}
```

### 401 Unauthorized - 토큰 오류

토큰 누락 예시:

```json
{
  "success": false,
  "message": "JWT 토큰이 존재하지 않습니다.",
  "errorCode": "JWT_TOKEN_NOT_FOUND"
}
```

### 500 Internal Server Error - 서버 내부 오류

Gemini API 호출 중 오류 발생 예시:

```json
{
  "success": false,
  "message": "외부 서비스 호출 중 오류가 발생했습니다.",
  "errorCode": "EXTERNAL_API_ERROR"
}
```

## 에러 처리 UX 명세

| 상황            | 사용자 노출 문구                                          | UI 동작                                        |
| --------------- | --------------------------------------------------------- | ---------------------------------------------- |
| `401` 토큰 오류 | `로그인이 만료되었습니다. 다시 로그인해 주세요.`          | 에러 버블 + 토스트 노출 후 로그인 유도         |
| `500` 서버 오류 | `일시적인 오류가 발생했어요. 잠시 후 다시 시도해 주세요.` | 에러 버블 + 토스트 노출, 동일 질문 재전송 가능 |
| 네트워크 오류   | `네트워크 연결을 확인해 주세요.`                          | 에러 버블 + 토스트 노출, 재시도 가능           |
| 타임아웃(30초)  | `응답이 지연되고 있어요. 다시 시도해 주세요.`             | 에러 버블 + 토스트 노출, 재시도 가능           |
| 사용자 중지     | `요청이 취소되었습니다.`                                  | 취소 버블 + 토스트 노출 후 종료                |

## 프론트 상태 모델

```ts
type ChatRole = 'user' | 'assistant';

interface ChatMessage {
  id: string;
  role: ChatRole;
  content: string;
  createdAt: string;
}

interface ChatUiState {
  isOpen: boolean;
  isLoading: boolean;
  input: string;
  messages: ChatMessage[];
}
```

## 수용 기준 (Acceptance Criteria)

- 사용자는 초기 진입 시 안내 문구와 빠른 질문 칩을 확인할 수 있다.
- 질문 전송 시 사용자 메시지가 즉시 보이고, 응답 전까지 로딩 상태가 유지된다.
- 응답은 백엔드 스트리밍 없이 수신되며, 프론트에서 점진적으로 표시된다.
- 로딩 중 `중지`로 요청 취소가 가능하다.
- `401`, `500`, 네트워크/타임아웃 오류에서 문구와 재시도 동작이 명세대로 동작한다.
